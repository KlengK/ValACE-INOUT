# ValACE In/Out: Secure Attendance System (Koha Integration)

![Base](https://img.shields.io/badge/Based_On-Omkar_InOut-lightgrey)
![Security](https://img.shields.io/badge/Security-AES_256_Encryption-red)
![Integration](https://img.shields.io/badge/System-ValACEPass-blue)
![Status](https://img.shields.io/badge/Deployment-Production-success)

> **Project Note:** This is a heavily modified and hardened fork of the [Koha In-Out Management System](https://github.com/omkar-b/koha-inout). It has been re-engineered to support **AES-256 Encrypted QR Codes** (ValACEPass) and integrates directly with the Valenzuela City Library's patron database.

## ðŸ“– Project Overview

The original *Koha In/Out* system provided basic attendance tracking via manual barcode entry. However, for a high-traffic public library like ValACE, we needed a solution that was faster and tamper-proof.

I refactored the core logic to transition from plain-text inputs to **Encrypted QR Code scanning**. This prevents "attendance spoofing" (where users generate fake QR codes) and streamlines the entry process by integrating directly with the **ValACEPass** mobile identity ecosystem.

## ðŸŽ¯ Key Modifications & Enhancements

### ðŸ”’ 1. Encrypted QR Support (The "ValACEPass" Integration)
* **The Problem:** Standard library cards use plain text (e.g., `VCL-12345`). Anyone can generate a QR code with this text to fake an entry.
* **My Solution:** Implemented **AES-256-CBC decryption** within the check-in controller. The system now expects an encrypted string generated by the ValACEPass app.
* **Workflow:**
    1.  Scanner reads encrypted string.
    2.  System attempts decryption using the daily rotation key.
    3.  If successful, it extracts the `borrowernumber` and logs the entry.

### âš¡ 2. Real-Time Logic Optimization
* **Debouncing:** Added logic to prevent "double scanning" (where a user scans twice in 1 second), which previously created duplicate database entries.
* **Status Validation:** Before logging "In," the system queries the Koha database to check if the patron is *already* marked as "In," automatically switching the mode to "Out" if necessary (Smart Toggle).

### ðŸŽ¨ 3. UI/UX Modernization
* Refreshed the interface with **Bootstrap 5** to match the library's branding.
* Added visual and audio feedback (Success Chime vs. Error Buzz) to speed up lines during peak hours.

## âš™ï¸ Technical Architecture

This system sits alongside the Koha ILS, connecting to the same MySQL database instance.

| Component | Tech Stack | Role |
| :--- | :--- | :--- |
| **Frontend** | HTML5, JS (AJAX) | Handles the QR scanner input stream and UI updates. |
| **Backend** | PHP 7.4 / 8.1 | Handles decryption and SQL transactions. |
| **Database** | MySQL / MariaDB | Direct connection to Koha's `statistics` and `borrowers` tables. |
| **Security** | OpenSSL Library | Manages the AES-256 decryption logic. |

## ðŸ’» Code Highlight: The Decryption Logic

*A snippet of the refactored controller handling the ValACEPass secure string.*

```php
function process_scan($encrypted_input) {
    // Define the cipher method
    $cipher = "aes-256-cbc";
    $secret_key = getenv('VALACE_SECRET_KEY');
    
    // Decrypt the incoming QR code
    $decrypted_cardnumber = openssl_decrypt($encrypted_input, $cipher, $secret_key, 0, $iv);

    if ($decrypted_cardnumber === false) {
        return json_encode(['status' => 'error', 'message' => 'Invalid Security Token']);
    }

    // Proceed to log attendance with the real card number
    return log_attendance_to_koha($decrypted_cardnumber);
}
